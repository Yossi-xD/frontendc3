<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - C³</title>
  <link rel="stylesheet" href="/dashboard Page/styles.css" />
</head>
<body>
  <header class="main-header">
    <div class="logo-section">
      <span class="logo-icon">📦</span>
      <span class="logo-text">C³</span>
    </div>
    <nav class="nav-links">
      <a href="#" class="active">Dashboard</a>
      <a href="../post delivery page/post-delivery.html">Post Delivery</a>
      <a href="../Browse Requests/browse-requests.html">Browse Requests</a>
      <a href="../track delivery/track-delivery.html">Track Delivery</a>
      <a href="../messages/index.html">Messages</a>
      <a href="../profile/profile.html">Profile</a>
      <a href="../payment page/payment.html">Payment</a>
      <a href="../accessibility/accessibility.html">Accessibility</a>
      <a href="../main/main.html">Logout</a>
    </nav>
  </header>

  <main class="dashboard">
    <section class="dashboard-header">
      <h1>Welcome back, <span id="userName" class="highlight">User</span>!</h1>
      <p>Here's what's happening with your deliveries today.</p>
    </section>

    <div id="statsContainer"></div>

    <div class="grid-2">
      <div class="card">
        <h3>Quick Actions</h3>
        <button class="btn blue quick-action-post" onclick="location.href='../post delivery page/post-delivery.html'">Post New Request</button>
        <button class="btn green quick-action-browse" onclick="location.href='../Browse Requests/browse-requests.html'">Browse Delivery Opportunities</button>
        <button class="btn purple quick-action-tracker" onclick="location.href='../track delivery/track-delivery.html'">Track Active Deliveries</button>
      </div>

      <div class="card">
        <h3>Recent Activity</h3>
        <div class="activity-item" data-type="delivery">
          <span>Delivered laptop to Yousef M.</span>
          <span class="badge completed">completed</span>
        </div>
        <div class="activity-item" data-type="request">
          <span>Posted request for art supplies</span>
          <span class="badge active">active</span>
        </div>
        <div class="activity-item" data-type="message">
          <span>New message from traveler Yousef</span>
          <span class="badge unread">unread</span>
        </div>
      </div>
    </div>

    <div class="card performance-chart">
      <h3>Delivery Performance</h3>
      <div class="chart-placeholder">Performance chart would be displayed here</div>
    </div>
  </main>

<script>
  const userName = localStorage.getItem("userName") || "User";
  const userRole = localStorage.getItem("userRole");
  const userEmail = localStorage.getItem("userEmail");
  const userId = localStorage.getItem("userId");
  const token = localStorage.getItem("token");

  document.getElementById("userName").textContent = userName;

  if (!userRole || !token || !userEmail || !userId) {
    alert("Session expired. Please log in again.");
    location.href = "../main/main.html";
  }

  const statsContainer = document.getElementById("statsContainer");

  if (userRole === "requester") {
    document.querySelector(".quick-action-tracker")?.remove();
    document.querySelector(".performance-chart")?.remove();
    document.querySelectorAll(".activity-item").forEach(item => {
      if (item.dataset.type === "delivery") item.remove();
    });

    Promise.all([
      fetch("/api/payments", {
        headers: { Authorization: "Bearer " + token }
      }).then(res => res.json()),
      fetch("/api/requests", {
        headers: { Authorization: "Bearer " + token }
      }).then(res => res.json())
    ])
    .then(([payments, requests]) => {
      const myRequestIds = requests
        .filter(r => String(r.createdBy) === userId)
        .map(r => String(r._id));

      const myPayments = payments.filter(p =>
        myRequestIds.includes(String(p.requestId)) &&
        (p.email === userEmail)
      );

      const pending = myPayments.filter(p => p.status?.toLowerCase() === "pending");
      const totalSpent = myPayments.reduce((sum, p) => sum + (p.amount || 0), 0);

      statsContainer.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><p>Pending Requests</p><h2>${pending.length}</h2></div>
          <div class="stat-card"><p>Accepted Requests</p><h2>-</h2></div>
          <div class="stat-card"><p>Delivered Items</p><h2>-</h2></div>
          <div class="stat-card"><p>Total Spent</p><h2>$${totalSpent}</h2></div>
        </div>`;
    })
    .catch(err => console.error("❌ Error loading requester dashboard:", err));

    } else if (userRole === "traveler") {
    Promise.all([
      fetch("/api/requests", {
        headers: { Authorization: "Bearer " + token }
      }).then(res => res.json()),
      fetch("/api/payments", {
        headers: { Authorization: "Bearer " + token }
      }).then(res => res.json())
    ])
    .then(([requests, payments]) => {
      const accepted = requests.filter(
        r => r.status?.toLowerCase() === "accepted" && String(r.assignedTo) === userId
      );
      const delivered = requests.filter(
        r => r.status?.toLowerCase() === "delivered" && String(r.assignedTo) === userId
      );

      const deliveredRequestIds = delivered.map(r => String(r._id));
      const earnings = payments
        .filter(p => deliveredRequestIds.includes(String(p.requestId)))
        .reduce((sum, p) => sum + (p.amount || 0), 0);

      statsContainer.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><p>Active Requests</p><h2>${accepted.length}</h2></div>
          <div class="stat-card"><p>Completed Deliveries</p><h2>${delivered.length}</h2></div>
          <div class="stat-card"><p>Rating</p><h2>4.8</h2></div>
          <div class="stat-card"><p>Earnings</p><h2>$${earnings}</h2></div>
        </div>`;
    })
    .catch(err => {
      console.error("❌ Error loading traveler dashboard:", err);
    });
  }


  
  if (userRole === "traveler") {
    // Hide "Post Delivery" link for travelers
    const navLinks = document.querySelectorAll(".nav-links a");
    navLinks.forEach(link => {
      if (link.textContent.trim() === "Post Delivery") {
        link.style.display = "none";
      }
    });
  }

</script>

</body>
</html>