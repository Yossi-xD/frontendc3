<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse Delivery Requests</title>
  <link rel="stylesheet" href="/Browse Requests/styles.css" />
</head>
<body>
  <header class="main-header">
    <div class="logo-section">
      <span class="logo-icon">📦</span>
      <span class="logo-text">C³</span>
    </div>
    <nav class="nav-links">
      <a href="../Dashboard Page/dashboard.html">Dashboard</a>
      <a href="../post delivery page/post-delivery.html">Post Delivery</a>
      <a href="../Browse Requests/browse-requests.html" class="active">Browse Requests</a>
      <a href="../track delivery/track-delivery.html">Track Delivery</a>
      <a href="../messages/index.html">Messages</a>
      <a href="../profile/profile.html">Profile</a>
      <a href="../payment page/payment.html">Payment</a>
      <a href="../accessibility/accessibility.html">Accessibility</a>
      <a href="../main/main.html">Logout</a>
    </nav>
  </header>

  <main>
    <h1>Browse Delivery Requests</h1>
    <p class="subtitle">Find delivery requests that match your travel route and earn money helping your community.</p>

    <section class="filters">
      <input type="search" placeholder="Search by title or description..." />
      <select><option>All Sizes</option></select>
      <select><option>All Urgency</option></select>
      <select><option>Newest First</option></select>
    </section>

    <section id="requests-container">
      <!-- Hardcoded Art Supplies Request -->
      <article class="request-card">
        <div class="request-header">
          <div class="request-title">🎨 Art Supplies Delivery</div>
          <div class="request-meta">
            <span>👤 Auto Generated</span>
            <span>⭐ 4.8</span>
            <span>🗓️ 7/25/2025</span>
          </div>
        </div>
        <p class="request-desc">Urgent delivery of art supplies for student project.</p>
        <div class="locations">
          <div><strong class="pickup">📍 Pickup:</strong> Tel Aviv</div>
          <div><strong class="dropoff">📍 Drop-off:</strong> Haifa</div>
        </div>
        <div class="footer-row">
          <span>💰 $35</span>
          <span>📦 Small (fits in a bag)</span>
          <span class="urgency-badge accepted">ACCEPTED</span>
        </div>
        <div class="btn-group">
          <button class="secondary">View Details</button>
        </div>
      </article>
    </section>
  </main>

<script>
  let hardcodedInserted = false;

async function fetchRequests() {
  const token = localStorage.getItem("token");
  const userRole = localStorage.getItem("userRole");
  const container = document.getElementById("requests-container");

  try {
    const res = await fetch("/api/requests", {
      headers: { Authorization: "Bearer " + token }
    });
    const data = await res.json();

    container.innerHTML = ""; // clear all before repopulating

    // ✅ Render all dynamic requests
    data.forEach((req) => {
      const card = buildRequestCard(req, userRole);
      container.prepend(card); // newest on top
    });

    // ✅ Only append the hardcoded request once
    if (!hardcodedInserted) {
      const hardcoded = {
        title: "🎨 Art Supplies Delivery",
        description: "Urgent delivery of art supplies for student project.",
        productLocation: "Tel Aviv",
        userLocation: "Haifa",
        payment: 35,
        status: "accepted",
        createdAt: "2025-07-25T00:00:00Z"
      };
      const staticCard = buildRequestCard(hardcoded, userRole, true);
      container.appendChild(staticCard); // always at bottom
      hardcodedInserted = true;
    }

  } catch (err) {
    console.error("Failed to fetch requests", err);
  }
}


  function buildRequestCard(req, userRole, isStatic = false) {
    const card = document.createElement("article");
    card.className = "request-card";
    const status = req.status?.toLowerCase();

    const showRequesterButtons = userRole === "requester" && !isStatic;
    const showTravelerButtons = userRole === "traveler" && !isStatic;

    card.innerHTML = `
      <div class="request-header">
        <div class="request-title">${req.title}</div>
        <div class="request-meta">
          <span>👤 Auto Generated</span>
          <span>⭐ ${isStatic ? "4.8" : "4.5"}</span>
          <span>📅 ${new Date(req.createdAt).toLocaleDateString()}</span>
        </div>
      </div>
      <p class="request-desc">${req.description || "No description provided."}</p>
      <div class="locations">
        <div><strong class="pickup">📍 Pickup:</strong> ${req.productLocation || "Not specified"}</div>
        <div><strong class="dropoff">📍 Drop-off:</strong> ${req.userLocation || "Not specified"}</div>
      </div>
      <div class="footer-row">
        <span>💰 $${req.payment || 0}</span>
        <span>📦 Small (fits in a bag)</span>
        <span class="urgency-badge ${status}">${status?.toUpperCase() || "NEW"}</span>
      </div>
      <div class="btn-group">
        <button class="secondary">View Details</button>
        ${showRequesterButtons ? `
          <button class="edit-btn" onclick='editRequest(${JSON.stringify(req)})'>Edit</button>
          <button class="danger" onclick="deleteRequest('${req._id}', this)">Cancel</button>
        ` : ""}
        ${showTravelerButtons ? (() => {
          if (status === "pending") {
            return `<button class="primary" onclick="acceptRequest('${req._id}', this)">Accept Request</button>`;
          } else if (status === "accepted") {
            return `<button class="primary" onclick="markDelivered('${req._id}', this)">Mark as Delivered</button>`;
          }
          return "";
        })() : ""}
      </div>
    `;
    return card;
  }

  function editRequest(req) {
    localStorage.setItem("editRequest", JSON.stringify(req));
    location.href = "../post delivery page/post-delivery.html";
  }

  function deleteRequest(id, button) {
    const token = localStorage.getItem("token");
    if (!confirm("Are you sure you want to cancel this request?")) return;

    fetch(`/api/requests/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    })
    .then(res => {
      if (!res.ok) throw new Error("Delete failed");
      button.closest(".request-card").remove();
    })
    .catch(err => {
      alert("Failed to cancel request.");
      console.error(err);
    });
  }

  function acceptRequest(id, btn) {
    const token = localStorage.getItem("token");
    fetch(`/api/requests/${id}/accept`, {
      method: "PATCH",
      headers: { Authorization: "Bearer " + token }
    })
    .then(res => res.json())
    .then(data => {
      alert("✅ Request accepted");
      btn.closest(".request-card").querySelector(".urgency-badge").textContent = "ACCEPTED";
      btn.closest(".btn-group").innerHTML = `<button class='primary' onclick="markDelivered('${id}', this)">Mark as Delivered</button>`;
    })
    .catch(err => alert("Error accepting request"));
  }

  function markDelivered(id, btn) {
    alert("📦 Marked as Delivered!");
window.location.href = "../Dashboard Page/dashboard.html";

    const token = localStorage.getItem("token");
    fetch(`/api/requests/${id}/deliver`, {
      method: "PATCH",
      headers: { Authorization: "Bearer " + token }
    })
    .then(res => res.json())
    .then(data => {
      alert("📦 Marked as Delivered!");
      const badge = btn.closest(".request-card").querySelector(".urgency-badge");
      badge.textContent = "DELIVERED";
      badge.className = "urgency-badge delivered";
      btn.remove();
    })
    .catch(err => alert("Error marking as delivered"));
  }

  document.addEventListener("DOMContentLoaded", fetchRequests);

  const userRole = localStorage.getItem("userRole");
  if (userRole === "traveler") {
    const navLinks = document.querySelectorAll(".nav-links a");
    navLinks.forEach(link => {
      if (link.textContent.trim() === "Post Delivery") {
        link.style.display = "none";
      }
    });
  }
</script>
</body>
</html>
