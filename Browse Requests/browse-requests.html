<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse Delivery Requests</title>
  <link rel="stylesheet" href="/Browse Requests/styles.css" />
</head>
<body>
  <header class="main-header">
    <div class="logo-section">
      <span class="logo-icon">📦</span>
      <span class="logo-text">C³</span>
    </div>
    <nav class="nav-links">
      <a href="../Dashboard Page/dashboard.html">Dashboard</a>
      <a href="../post delivery page/post-delivery.html">Post Delivery</a>
      <a href="../Browse Requests/browse-requests.html" class="active">Browse Requests</a>
      <a href="../track delivery/track-delivery.html">Track Delivery</a>
      <a href="../messages/index.html">Messages</a>
      <a href="../profile/profile.html">Profile</a>
      <a href="../payment page/payment.html">Payment</a>
      <a href="../accessibility/accessibility.html">Accessibility</a>
      <a href="../main/main.html">Logout</a>
    </nav>
  </header>

  <main>
    <h1>Browse Delivery Requests</h1>
    <p class="subtitle">Find delivery requests that match your travel route and earn money helping your community.</p>

    <section class="filters">
      <input type="search" placeholder="Search by title or description..." />
      <select><option>All Sizes</option></select>
      <select><option>All Urgency</option></select>
      <select><option>Newest First</option></select>
    </section>

    <section id="requests-container">
      <!-- Hardcoded example (always stays) -->
      <article class="request-card">
        <div class="request-header">
          <div class="request-title">Art supplies for student</div>
          <div class="request-meta">
            <span>👤 Hamad</span>
            <span>⭐ 4.9</span>
            <span>📅 7/31/2025</span>
          </div>
        </div>
        <p class="request-desc">Canvas, paints, and brushes from art store to university dorm.</p>
        <div class="locations">
          <div><strong class="pickup">📍 Pickup</strong> 789 Art Store Blvd, Berkeley, CA 94704</div>
          <div><strong class="dropoff">📍 Drop-off</strong> UC Berkeley Dorms, Berkeley, CA 94720</div>
        </div>
        <div class="footer-row">
          <span>📦 large (8 lbs)</span>
          <span>📅 Preferred: 1/24/2025</span>
          <span class="urgency-badge urgency-high">DONE ✅</span>
        </div>
        <div class="btn-group">
          <button class="secondary">View Details</button>
        </div>
      </article>
    </section>
  </main>

<script>
  async function fetchRequests() {
    const token = localStorage.getItem("token");
    const userRole = localStorage.getItem("userRole");
    const container = document.getElementById("requests-container");

    try {
      const res = await fetch("/api/requests", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();

      data.forEach((req) => {
        const card = document.createElement("article");
        card.className = "request-card";

        const showButtons = userRole === "requester";

        card.innerHTML = `
          <div class="request-header">
            <div class="request-title">${req.title}</div>
            <div class="request-meta">
              <span>👤 Auto Generated</span>
              <span>⭐ 4.5</span>
              <span>📅 ${new Date(req.createdAt).toLocaleDateString()}</span>
            </div>
          </div>
          <p class="request-desc">${req.description || "No description provided."}</p>
          <div class="locations">
            <div><strong class="pickup">📍 Pickup</strong> ${req.productLocation || "Not specified"}</div>
            <div><strong class="dropoff">📍 Drop-off</strong> ${req.userLocation || "Not specified"}</div>
          </div>
          <div class="footer-row">
            <span>📦 size unknown</span>
            <span>📅 Preferred: unknown</span>
            <span class="urgency-badge urgency-medium">NEW</span>
          </div>
          <div class="btn-group">
            <button class="secondary">View Details</button>
            ${showButtons ? `
              <button class="edit-btn" onclick='editRequest(${JSON.stringify(req)})'>Edit</button>
              <button class="danger" onclick="deleteRequest('${req._id}', this)">Cancel</button>
            ` : ""}
          </div>
        `;
        container.prepend(card);
      });
    } catch (err) {
      console.error("Failed to fetch requests", err);
    }
  }

  function editRequest(req) {
    localStorage.setItem("editRequest", JSON.stringify(req));
    location.href = "../post delivery page/post-delivery.html";
  }

  function deleteRequest(id, button) {
    const token = localStorage.getItem("token");
    if (!confirm("Are you sure you want to cancel this request?")) return;

    fetch(`/api/requests/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    })
      .then(res => {
        if (!res.ok) throw new Error("Delete failed");
        button.closest(".request-card").remove();
      })
      .catch(err => {
        alert("Failed to cancel request.");
        console.error(err);
      });
  }

  document.addEventListener("DOMContentLoaded", fetchRequests);
</script>


</body>
</html>
